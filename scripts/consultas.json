{
  "explicacion_1": "Contar el número de inspecciones por restaurante para decidir la relación One-to-X",
  "consulta_1": [
    { "$group": { "_id": "$restaurant_id", "num_inspections": { "$sum": 1 } } },
    { "$sort": { "num_inspections": -1 } },
    { "$limit": 10 }
  ],
  
  "explicacion_2": "Crear la colección nueva con los restaurantes y su respectiva array de inspecciones",
  "consulta_2": [
    {
      "$addFields": {
        "restaurant_id_obj": { "$toObjectId": "$restaurant_id" }
      }
    },
    {
      "$lookup": {
        "from": "restaurants",
        "localField": "restaurant_id_obj",
        "foreignField": "_id",
        "as": "restaurant_info"
      }
    },
    {
      "$unwind": "$restaurant_info"
    },
    {
      "$group": {
        "_id": "$restaurant_info._id",
        "name": { "$first": "$restaurant_info.name" },
        "address": { "$first": "$restaurant_info.address" },
        "outcode": { "$first": "$restaurant_info.outcode" },
        "postcode": { "$first": "$restaurant_info.postcode" },
        "rating": { "$first": "$restaurant_info.rating" },
        "type_of_food": { "$first": "$restaurant_info.type_of_food" },
        "URL": { "$first": "$restaurant_info.URL" },
        "inspections": { "$push": "$$ROOT" }
      }
    },
    {
      "$out": "restaurants_with_inspections"
    }
  ],

  "explicacion_3": "Verificar que la colección se ha creado correctamente y que los restaurantes tienen inspecciones dentro",
  "consulta_3": { "inspections": { "$ne": [] } },

  "explicacion_4": "Crear una validación de esquema para asegurar que los datos en 'restaurants_with_inspections' sean correctos",
  "consulta_4": {
    "$jsonSchema": {
      "bsonType": "object",
      "required": ["name", "address", "outcode", "postcode", "rating", "type_of_food", "URL", "inspections"],
      "properties": {
        "_id": {
          "bsonType": "objectId",
          "description": "Debe ser un ObjectId"
        },
        "name": {
          "bsonType": "string",
          "description": "El nombre del restaurante es obligatorio y debe ser una cadena"
        },
        "address": {
          "bsonType": "string",
          "description": "La dirección es obligatoria y debe ser una cadena"
        },
        "outcode": {
          "bsonType": "string",
          "description": "Código de área postal obligatorio"
        },
        "postcode": {
          "bsonType": "string",
          "description": "El código postal es obligatorio"
        },
        "rating": {
          "bsonType": ["double", "int"],
          "minimum": 0,
          "maximum": 10,
          "description": "La calificación del restaurante debe estar entre 0 y 10"
        },
        "type_of_food": {
          "bsonType": "string",
          "description": "El tipo de comida es obligatorio"
        },
        "URL": {
          "bsonType": "string",
          "pattern": "^(http|https)://.*",
          "description": "Debe ser una URL válida que comience con http o https"
        },
        "inspections": {
          "bsonType": "array",
          "description": "Debe ser un array con las inspecciones",
          "items": {
            "bsonType": "object",
            "required": ["id", "date", "result", "certificate_number"],
            "properties": {
              "id": {
                "bsonType": "string",
                "description": "ID de la inspección"
              },
              "date": {
                "bsonType": "string",
                "description": "Fecha de la inspección"
              },
              "result": {
                "bsonType": "string",
                "enum": ["Pass", "Fail", "Warning Issued", "Violation Issued", "No Violation Issued"],
                "description": "Resultado de la inspección"
              },
              "certificate_number": {
                "bsonType": "int",
                "description": "Número de certificado"
              }
            }
          }
        }
      }
    }
  },

  "explicacion_5": "Buscar restaurantes de tipo 'Chinese'",
  "consulta_5": { "type_of_food": "Chinese" },

  "explicacion_6": "Listar inspecciones con violaciones y ordenarlas por fecha",
  "consulta_6": [
    { "$unwind": "$inspections" },
    { "$match": { "inspections.result": "Violation Issued" } },
    { "$sort": { "inspections.date": -1 } }
  ],

  "explicacion_7": "Buscar restaurantes con calificación superior a 4",
  "consulta_7": { "rating": { "$gt": 4 } },

  "explicacion_8": "Agrupar restaurantes por tipo de comida y calcular la calificación promedio",
  "consulta_8": [
    { "$group": { "_id": "$type_of_food", "average_rating": { "$avg": "$rating" } } },
    { "$sort": { "average_rating": -1 } }
  ],

  "explicacion_9": "Contar el número de inspecciones por resultado y mostrar los porcentajes",
  "consulta_9": [
    { "$unwind": "$inspections" },
    {
      "$group": {
        "_id": "$inspections.result",
        "count": { "$sum": 1 }
      }
    },
    {
      "$setWindowFields": {
        "output": {
          "total": { "$sum": "$count" }
        }
      }
    },
    {
      "$project": {
        "count": 1,
        "percentage": { "$multiply": [{ "$divide": ["$count", "$total"] }, 100] }
      }
    },
    { "$sort": { "count": -1 } }
  ],

  "explicacion_10": "Trobar restaurants amb inspeccions fallides",
  "consulta_10": [
    { "$unwind": "$inspections" },
    { "$match": { 
        "inspections.result": { "$in": ["Failed", "Violation Issued"] }
    }},
    { "$group": { "_id": "$name", "count": { "$sum": 1 } } },
    { "$sort": { "count": -1 } }
  ],
  
  "explicacion_11": "Trobar restaurants amb inspeccions fallides",
  "consulta_11": { "address": "33 Richmond Road", "inspections.1": { $exists: true } },

  "explicacion_12": "Obtenir restaurants amb una certa qualificació i una inspecció amb un sector determinat",
  "consulta_12": { "rating": { $gte: 4 }, "inspections.sector": "Grocery-Retail - 808" }
  
}
